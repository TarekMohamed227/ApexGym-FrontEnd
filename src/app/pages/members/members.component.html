<!-- src/app/pages/members/members.component.html -->
<div class="container mt-4">
  
  <!-- HEADER SECTION -->
  <div class="d-flex justify-content-between align-items-center mb-4">
    <div>
      <h2><i class="fas fa-users me-2"></i>Gym Members</h2>
      <small class="text-muted" *ngIf="!isLoading()">
        Loaded {{ members().length }} members
      </small>
    </div>
    <div>
      <button class="btn btn-outline-secondary me-2" (click)="onRefresh()"
              [disabled]="isLoading()">
        <i class="fas fa-sync-alt" [class.fa-spin]="isLoading()"></i> Refresh
      </button>
      <button class="btn btn-primary" (click)="toggleAddForm()"
              [disabled]="editingMember() !== null">
        <i class="fas fa-plus me-1"></i>
        {{ showAddForm() ? 'Cancel' : 'Add Member' }}
      </button>
    </div>
  </div>

  <!-- LOADING INDICATOR -->
  <div *ngIf="isLoading()" class="text-center py-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading members...</span>
    </div>
    <p class="mt-2 text-muted">Loading member data...</p>
  </div>

  <!-- ERROR DISPLAY -->
  <div *ngIf="error() && !isLoading()" class="alert alert-danger alert-dismissible">
    <i class="fas fa-exclamation-triangle me-2"></i>
    {{ error() }}
    <button type="button" class="btn-close" (click)="clearError()"></button>
  </div>

  <!-- ADD MEMBER FORM -->
  <div *ngIf="showAddForm()" class="card mb-4">
    <div class="card-header bg-primary text-white">
      <h5 class="mb-0"><i class="fas fa-user-plus me-2"></i>Register New Member</h5>
    </div>
    <div class="card-body">
      <form (ngSubmit)="onAddMember()" #memberForm="ngForm">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">First Name *</label>
              <input type="text" class="form-control" 
                     [(ngModel)]="newMember.firstName" 
                     name="firstName" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Last Name *</label>
              <input type="text" class="form-control" 
                     [(ngModel)]="newMember.lastName" 
                     name="lastName" required>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Email *</label>
              <input type="email" class="form-control" 
                     [(ngModel)]="newMember.email" 
                     name="email" required>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Date of Birth</label>
              <input type="date" class="form-control" 
                     [(ngModel)]="newMember.dateOfBirth" 
                     name="dateOfBirth">
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Membership Plan</label>
          <select class="form-select" [(ngModel)]="newMember.membershipPlanId" name="membershipPlanId">
            <option value="1">Basic - $49.99/month</option>
            <option value="2">Premium - $99.99/month</option>
            <option value="3">VIP - $199.99/month</option>
          </select>
        </div>

        <div class="d-flex gap-2">
          <button type="submit" class="btn btn-success" 
                  [disabled]="!newMember.firstName || !newMember.lastName || !newMember.email">
            <i class="fas fa-save me-1"></i> Register Member
          </button>
          <button type="button" class="btn btn-secondary" (click)="toggleAddForm()">
            <i class="fas fa-times me-1"></i> Cancel
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- EDIT MEMBER FORM -->
  <div *ngIf="editingMember()" class="card mb-4 border-warning">
    <div class="card-header bg-warning text-dark">
      <h5 class="mb-0">
        <i class="fas fa-edit me-2"></i>
        Edit Member: {{ editingMember()?.firstName }} {{ editingMember()?.lastName }}
      </h5>
    </div>
    <div class="card-body">
      <form (ngSubmit)="onUpdateMember()">
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">First Name</label>
              <input type="text" class="form-control" 
                     [(ngModel)]="editMemberForm.firstName" 
                     name="editFirstName"
                     [placeholder]="editingMember()?.firstName">
              <small class="text-muted">Leave empty to keep current: {{ editingMember()?.firstName }}</small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Last Name</label>
              <input type="text" class="form-control" 
                     [(ngModel)]="editMemberForm.lastName" 
                     name="editLastName"
                     [placeholder]="editingMember()?.lastName">
              <small class="text-muted">Leave empty to keep current: {{ editingMember()?.lastName }}</small>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Email</label>
              <input type="email" class="form-control" 
                     [(ngModel)]="editMemberForm.email" 
                     name="editEmail"
                     [placeholder]="editingMember()?.email">
              <small class="text-muted">Leave empty to keep current: {{ editingMember()?.email }}</small>
            </div>
          </div>
          <div class="col-md-6">
            <div class="mb-3">
              <label class="form-label">Date of Birth</label>
              <input type="date" class="form-control" 
                     [value]="getDateInputValue(editMemberForm.dateOfBirth)"
                     (input)="editMemberForm.dateOfBirth = $any($event.target).valueAsDate"
                     name="editDateOfBirth">
              <small class="text-muted" *ngIf="editingMember()?.dateOfBirth">
                Current: {{ editingMember()?.dateOfBirth | date:'mediumDate' }}
              </small>
            </div>
          </div>
        </div>

        <div class="mb-3">
          <label class="form-label">Membership Plan</label>
          <select class="form-select" [(ngModel)]="editMemberForm.membershipPlanId" name="editMembershipPlanId">
            <option [value]="undefined">Keep current plan ({{ getMembershipPlanName(editingMember()?.membershipPlanId || 1) }})</option>
            <option value="1">Basic - $49.99/month</option>
            <option value="2">Premium - $99.99/month</option>
            <option value="3">VIP - $199.99/month</option>
          </select>
        </div>

        <div class="d-flex gap-2">
          <!-- FIX: Use a helper method to check for changes -->
          <button type="submit" class="btn btn-warning" 
                  [disabled]="!hasFormChanges()">
            <i class="fas fa-save me-1"></i> Update Member
          </button>
          <button type="button" class="btn btn-secondary" (click)="cancelEdit()">
            <i class="fas fa-times me-1"></i> Cancel
          </button>
        </div>

        <!-- Changes Preview -->
        <!-- FIX: Use helper method instead of Object.keys -->
        <div *ngIf="hasFormChanges()" class="mt-3 p-2 bg-light rounded">
          <h6 class="mb-2">Changes to be made:</h6>
          <ul class="list-unstyled small mb-0">
            <li *ngIf="editMemberForm.firstName">
              <strong>First Name:</strong> {{ editingMember()?.firstName }} → {{ editMemberForm.firstName }}
            </li>
            <li *ngIf="editMemberForm.lastName">
              <strong>Last Name:</strong> {{ editingMember()?.lastName }} → {{ editMemberForm.lastName }}
            </li>
            <li *ngIf="editMemberForm.email">
              <strong>Email:</strong> {{ editingMember()?.email }} → {{ editMemberForm.email }}
            </li>
            <li *ngIf="editMemberForm.dateOfBirth">
              <strong>Date of Birth:</strong> {{ editingMember()?.dateOfBirth | date:'mediumDate' }} → {{ editMemberForm.dateOfBirth | date:'mediumDate' }}
            </li>
            <li *ngIf="editMemberForm.membershipPlanId">
              <strong>Membership Plan:</strong> {{ getMembershipPlanName(editingMember()?.membershipPlanId || 1) }} → {{ getMembershipPlanName(editMemberForm.membershipPlanId) }}
            </li>
          </ul>
        </div>
      </form>
    </div>
  </div>

  <!-- MEMBERS LIST -->
  <div *ngIf="!isLoading() && members().length > 0; else noMembers">
    <div class="table-responsive">
      <table class="table table-striped table-hover">
        <thead class="table-dark">
          <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Date of Birth</th>
            <th>Membership</th>
            <th>Registration Date</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let member of members()" 
              [class.table-warning]="editingMember()?.id === member.id">
            <td><strong>{{ member.id }}</strong></td>
            <td>
              <div class="fw-bold">{{ member.firstName }} {{ member.lastName }}</div>
            </td>
            <td>{{ member.email }}</td>
            <td>
              <span *ngIf="member.dateOfBirth; else noDate">
                {{ member.dateOfBirth | date:'mediumDate' }}
              </span>
              <ng-template #noDate>
                <span class="text-muted">Not set</span>
              </ng-template>
            </td>
            <td>
              <span class="badge" 
                    [class]="getMembershipBadgeClass(member.membershipPlanId)">
                {{ getMembershipPlanName(member.membershipPlanId || 1) }}
              </span>
            </td>
            <td>
              <span *ngIf="member.registrationDate; else noRegDate">
                {{ member.registrationDate | date:'mediumDate' }}
              </span>
              <ng-template #noRegDate>
                <span class="text-muted">N/A</span>
              </ng-template>
            </td>
            <td>
              <div class="btn-group btn-group-sm">
                <button class="btn btn-outline-primary" 
                        (click)="onEditMember(member)"
                        [disabled]="editingMember() !== null"
                        title="Edit member">
                  <i class="fas fa-edit"></i> Edit
                </button>
                <button class="btn btn-outline-danger" 
                        (click)="onDeleteMember(member.id)"
                        [disabled]="editingMember() !== null"
                        title="Delete member">
                  <i class="fas fa-trash"></i> Delete
                </button>
              </div>
              
              <!-- Editing indicator -->
              <div *ngIf="editingMember()?.id === member.id" class="mt-1">
                <small class="text-warning">
                  <i class="fas fa-pencil-alt me-1"></i>Currently editing...
                </small>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- NO MEMBERS STATE -->
  <ng-template #noMembers>
    <div *ngIf="!isLoading()" class="alert alert-info text-center">
      <i class="fas fa-info-circle me-2"></i>
      No members found. 
      <button class="btn btn-sm btn-outline-info ms-2" (click)="toggleAddForm()">
        Add your first member
      </button>
    </div>
  </ng-template>

  <!-- STATISTICS CARD -->
  <div *ngIf="!isLoading() && members().length > 0" class="card mt-4">
    <div class="card-body">
      <h5 class="card-title">
        <i class="fas fa-chart-bar me-2"></i>Members Statistics
      </h5>
      <div class="row text-center">
        <div class="col-md-3">
          <div class="stat-item">
            <h3 class="text-primary">{{ members().length }}</h3>
            <small class="text-muted">Total Members</small>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-item">
            <h3 class="text-success">{{ getMembersByPlan(1) }}</h3>
            <small class="text-muted">Basic Plan</small>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-item">
            <h3 class="text-warning">{{ getMembersByPlan(2) }}</h3>
            <small class="text-muted">Premium Plan</small>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stat-item">
            <h3 class="text-danger">{{ getMembersByPlan(3) }}</h3>
            <small class="text-muted">VIP Plan</small>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>